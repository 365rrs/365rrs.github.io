<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="author" content="gaomingxicn@163.com"/>
    <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
    <script type="text/javascript" src="/ruxitagentjs_ICA2SVfhjqrx_10163190319101308.js" data-dtconfig="rid=RID_-974630914|rpid=1921480817|domain=haier.net|reportUrl=/rb_28a7920d-5600-4762-9d19-ddaa2c73ff04|app=d99802f8ecb537ed|featureHash=ICA2SVfhjqrx|srsr=25000|rdnt=1|uxrgce=1|bp=2|srms=1,1,,,|uxrgcm=100,25,300,3;100,25,300,3|dpvc=1|md=1=a.header-user-name|lastModification=1553259951229|dtVersion=10163190319101308|tp=500,50,0,1|agentUri=/ruxitagentjs_ICA2SVfhjqrx_10163190319101308.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script>
        // ES平台返回数据对照JSON
        var analysisJsonString = '{"message":"错误代码","detail":"错误信息","data":"结果","progress":{"Complete":"汇算已完成","NotFound":"产品或客户不存在","CustomerHWorkNotFound":"HWork客户不存在","CustomerBTBRRSNotFound":"365RRS客户信息不存在","CustomerHWorkNotSync":"HWork客户未同步","CustomerBTBRRSNotSync":"365RRS客户信息未同步","ProductHWorkNotFound":"HWork产品不存在","ProductBTBRRSNotFound":"365RRS产品不存在","ProductHWorkNotSync":"HWork产品信息未同步","ProductBTBRRSNotSync":"365RRS产品信息未同步","message":"汇算进度"},"notSaleReason":{"HWorkProductInvalid":"HWork产品无效或已下架","BtbrrsProductInvalid":"365RRS产品无效或已下架","HWorkCustomerInvalid":"HWork客户无效或已下架","HWorkCustomerExclude":"HWork中心小微排除客户","BtbrrsCustomerInvalid":"365RRS客户无效或已下架","CustomerBrandNotMatch":"客户品牌标签与产品品牌不匹配","CustomerLaunchLabelNotMatch":"客户标签与产品投放标签不匹配联系总部修改按标签投放规则","CustomerSaleLabelNotMatch":"客户信息与销售样表不匹配","CustomerNoStore":"客户无实体门店","HWorkNotConfigure":"未投放","message":"不可销售原因"},"notReserveReason":{"LifeCycleNotMatch":"产品生命周期闸口","SixSigmaNotMatch":"6西伽马质量闸口","GvsNonProfit":"产品非盈利型号闸口","message":"不可预定原因"},"refreshed":"是否已刷新","notSaleStateNow":"当前不可销售原因","notReserveStateNow":"当前预定售原因","refreshError":"重新汇算时错误"}';
        // 转换为JSON对象
        var analysis = JSON.parse(analysisJsonString);
        // 需要刷新的几个参数结果
        var refreshJsonString = '{"CustomerHWorkNotSync":"refresh","ProductHWorkNotSync":"refresh","CustomerBTBRRSNotSync":"refresh"}';
        // 转换为JSON对象
        var refreshJSON = JSON.parse(refreshJsonString);
        // 请求地址
        var url = 'http://btbrrs-analysis-v2.qdct-lsb.haier.net/api/v1/diagnose/relation';

        function createXmlHttp() {
            // 创建请求
            var xmlhttp;
            // 获取请假
            if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari
                xmlhttp = new XMLHttpRequest();
            } else {// code for IE6, IE5
                xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
            }
            return xmlhttp;
        }

        function searchEs() {
            resetTexts();
            // 获取客户编码
            var customer_code = document.getElementById("customer_code").value.trim();
            // 获取产品编码
            var product_code = document.getElementById("product_code").value.trim();
            // 检查参数
            if (customer_code == '' || customer_code == 'undefined' || product_code == '' || product_code == 'undefined') {
                alert("客户编码或产品编码不能为空");
                return null;
            }
            var xmlhttp = createXmlHttp();
            xmlhttp.open("GET", url + "/" + product_code + "/" + customer_code, false);
            xmlhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xmlhttp.send();
            // 记录查询结果
            document.getElementById("txts").value = xmlhttp.responseText;
            // 解析返回结果
            parsing(xmlhttp.responseText)
        }

        function parsing(responseText) {
            // 获取JSON
            var resultJSON = JSON.parse(responseText);
            // 解析JSON对象数据
            var message = resultJSON.message;
            var detail = resultJSON.detail;
            var progress = resultJSON.data.progress;
            var notSaleReason = resultJSON.data.notSaleReason;
            var notReserveReason = resultJSON.data.notReserveReason;

            // 翻译查询结果
            var resultMsg = '';
            // 检查汇算进度
            resultMsg += analysis.progress.message + ':' + analysis.progress[progress] + '\n';
            // 不可销售原因
            resultMsg += analysis.notSaleReason.message + ':' + analysis.notSaleReason[notSaleReason] + '\n';
            // 不可预定原因
            resultMsg += analysis.notReserveReason.message + ':' + analysis.notReserveReason[notReserveReason] + '\n';

            // 检查是否需要刷新
            var flag = false;
            if ('refresh' == refreshJSON[progress] || 'refresh' == refreshJSON[notSaleReason] || 'refresh' == refreshJSON[notReserveReason]) {
                flag = true;
                resultMsg += '识别到需要刷新ES平台数据，稍后自动调用刷新链接...' + '\n';
            }
            // 查询结果返回前台
            saveTexts(resultMsg);
            // 刷新
            if (flag) {
                refreshEs();
            }
        }

        function saveTexts(resultString) {
            document.getElementById("txtparse").value = resultString;
        }

        // 重置
        function resetEs() {
            // 获取客户编码
            document.getElementById("customer_code").value = "";
            // 获取产品编码
            document.getElementById("product_code").value = "";
            // 清空文本框旧数据
            resetTexts();
        }

        // 清空查询结果
        function resetTexts() {
            // 清空文本框旧数据
            document.getElementById("txts").value = "";
            document.getElementById("txtparse").value = "";
        }

        // 根据客户编码和产品编码刷新数据
        function submitRefresh(product_code, customer_code) {
            var xmlhttp = createXmlHttp();
            xmlhttp.open("GET", url + "/" + product_code + "/" + customer_code + '?auto_refresh', false);
            xmlhttp.send();

            // 获取JSON
            var resultJSON = JSON.parse(xmlhttp.responseText);
            // 解析JSON对象数据
            var progress = resultJSON.data.progress;
            var notSaleReason = resultJSON.data.notSaleReason;
            var notReserveReason = resultJSON.data.notReserveReason;

            // 翻译查询结果
            var resultMsg = '';
            // 检查汇算进度
            resultMsg += analysis.progress.message + ':' + analysis.progress[progress] + '\n';
            // 不可销售原因
            resultMsg += analysis.notSaleReason.message + ':' + analysis.notSaleReason[notSaleReason] + '\n';
            // 不可预定原因
            resultMsg += analysis.notReserveReason.message + ':' + analysis.notReserveReason[notReserveReason] + '\n';
            // alert
            alert(resultMsg);
        }

        // 刷新事件
        function refreshEs() {
            // 获取客户编码
            var customer_code = document.getElementById("customer_code").value.trim();
            // 获取产品编码
            var product_code = document.getElementById("product_code").value.trim();
            // 检查参数
            if (customer_code == '' || customer_code == 'undefined' || product_code == '' || product_code == 'undefined') {
                alert("客户编码或产品编码不能为空");
                return null;
            }
            // 调用刷新事件
            submitRefresh(product_code, customer_code);
        }
    </script>
    <title>ES平台闸口校验</title>
</head>
<body>

<div class="container">
    <div class="row">
        <div class="col-md-2"></div>
        <div class="col-md-8">
            <div class="page-header">
                <h3 class="text-center">365RRS官网产品上线查询(ES平台闸口校验)
                    <small>v2.0</small>
                </h3>
                <span id="helpBlock"
                      class="help-block">说明：本次版本更新主要增加对Bootstrap3 CSS样式引用，CSS文件从公网CDN加载，因此使用时需链接公网环境。</span>
            </div>
            <div class="form-horizontal">
                <div class="form-group">
                    <label for="customer_code" class="col-sm-2 control-label">客户编码:</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control" id="customer_code" placeholder="客户编码">
                    </div>
                </div>
                <div class="form-group">
                    <label for="product_code" class="col-sm-2 control-label">产品编码:</label>
                    <div class="col-sm-8" data-toggle="tooltip">
                        <input type="text" class="form-control" id="product_code" placeholder="产品编码">
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                        <div class="btn-toolbar" role="toolbar" aria-label="...">
                            <button type="button" class="btn btn-primary" onclick="searchEs()">
                                <span class="glyphicon glyphicon-search" aria-hidden="true"></span> 查询
                            </button>
                            <button type="button" class="btn btn-primary" onclick="resetEs()">
                                <span class="glyphicon glyphicon-wrench" aria-hidden="true"></span> 重置
                            </button>
                            <button type="button" class="btn btn-primary" onclick="resetTexts()">
                                <span class="glyphicon glyphicon-trash" aria-hidden="true"></span> 清空查询结果
                            </button>
                            <button type="button" class="btn btn-primary" onclick="refreshEs()">
                                <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> 手动刷新
                            </button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="txts" class="col-sm-2 control-label">查询结果:</label>
                    <div class="col-sm-8">
                        <textarea class="form-control" rows="4" id="txts"></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <label for="txtparse" class="col-sm-2 control-label">结果解析:</label>
                    <div class="col-sm-8">
                        <textarea class="form-control" rows="4" id="txtparse"></textarea>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2"></div>
    </div>
</div>
</body>
</html>
